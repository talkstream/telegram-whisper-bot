# Admin Guide

Руководство администратора Telegram Whisper Bot.

## Доступ

Админ-команды доступны только владельцу бота (BOT_OWNER_ID в переменных окружения).

## Команды

### Управление пользователями

#### `/user [search] [--page N]`

Поиск пользователей по username, имени или ID.

```
/user              # Все пользователи (первая страница)
/user john         # Поиск по "john"
/user 12345        # Поиск по ID (частичное совпадение)
/user john --page 2  # Вторая страница результатов
```

**Вывод:**
- User ID
- Username
- Имя
- Баланс минут
- Дата регистрации
- Последняя активность

#### `/credit <user_id> <minutes>`

Добавить минуты пользователю.

```
/credit 123456789 30   # Добавить 30 минут пользователю 123456789
```

**Примечания:**
- Отрицательные значения вычитают минуты
- Пользователь получает уведомление о зачислении

### Trial система

#### `/review_trials`

Просмотр ожидающих запросов на trial.

Показывает inline-кнопки:
- ✅ Approve — одобрить (зачисляет 15 минут)
- ❌ Deny — отклонить

После одобрения пользователь получает уведомление.

### Статистика

#### `/stat`

Общая статистика использования:
- Всего пользователей
- Активных за 24ч / 7д / 30д
- Общее количество транскрипций
- Общая длительность обработанного аудио

#### `/cost`

Расходы на обработку:
- Стоимость ASR (DashScope)
- Стоимость LLM (Qwen/Gemini)
- Итого за период

#### `/metrics [hours]`

Детальные метрики производительности.

```
/metrics       # За последний час
/metrics 24    # За 24 часа
/metrics 168   # За неделю
```

**Показывает:**
- Количество транскрипций
- Средняя длительность обработки
- TTFT (time to first token)
- Успешность (%)
- Распределение по языкам

### Очередь и задачи

#### `/status`

Статус MNS очереди:
- Pending jobs
- Processing jobs
- Completed (за час)
- Failed (за час)

#### `/flush`

Очистка зависших задач:
- Задачи в статусе "processing" > 10 минут
- Задачи без обновлений > 30 минут

**Использовать с осторожностью** — может прервать легитимные задачи.

#### `/batch [user_id]`

Показать очередь задач пользователя.

```
/batch              # Все активные задачи
/batch 123456789    # Задачи конкретного пользователя
```

### Экспорт данных

#### `/export [type] [days]`

Экспорт данных в CSV.

```
/export users 30      # Пользователи за 30 дней
/export logs 7        # Логи транскрипций за 7 дней
/export payments 90   # Платежи за 90 дней
```

**Типы:**
- `users` — список пользователей
- `logs` — логи транскрипций
- `payments` — история платежей

### Отчёты

#### `/report [daily|weekly]`

Генерация отчёта.

```
/report daily    # Дневной отчёт
/report weekly   # Недельный отчёт
```

**Содержит:**
- Новые пользователи
- Транскрипции (количество, длительность)
- Доходы
- Топ пользователей

## Автоматические уведомления

### Низкий баланс

Пользователи получают уведомление когда:
- Баланс падает ниже 5 минут
- После каждой транскрипции при низком балансе

### Trial запросы

Админ получает уведомление при новых запросах на trial.

### Ошибки обработки

Админ получает уведомление при:
- Repeated failures (>3 подряд)
- Queue overflow (>100 pending)
- Service unavailable

## Мониторинг

### Логи Function Compute

```bash
# Webhook handler
s logs --tail webhook-handler

# Audio processor
s logs --tail audio-processor
```

### Alibaba Cloud Console

1. Function Compute → Metrics
2. Tablestore → Monitoring
3. MNS → Queue Statistics

### Ключевые метрики

| Метрика | Норма | Алерт |
|---------|-------|-------|
| Cold start | < 3 сек | > 5 сек |
| Processing time | < 30 сек/мин | > 60 сек/мин |
| Success rate | > 95% | < 90% |
| Queue depth | < 10 | > 50 |

## Типичные операции

### Добавить минуты за баг

```
/user <username>           # Найти user_id
/credit <user_id> <min>    # Зачислить компенсацию
```

### Проверить проблему пользователя

```
/user <username>           # Проверить баланс, статус
/batch <user_id>           # Проверить очередь задач
/export logs 1             # Посмотреть последние логи
```

### Очистить зависшую очередь

```
/status                    # Проверить состояние
/flush                     # Очистить зависшие
/status                    # Подтвердить очистку
```

### Экстренное отключение

При серьёзных проблемах:

```bash
# Остановить webhook
curl -X POST "https://api.telegram.org/bot${BOT_TOKEN}/deleteWebhook"

# После исправления — восстановить
curl -X POST "https://api.telegram.org/bot${BOT_TOKEN}/setWebhook" \
  -d '{"url": "https://your-endpoint/webhook"}'
```

## Безопасность

### Что НЕ делать

- Не давать `/credit` без причины
- Не использовать `/flush` без проверки `/status`
- Не экспортировать данные на незащищённые устройства
- Не делиться BOT_TOKEN

### Логирование действий

Все админ-действия логируются:
- User ID админа
- Действие
- Параметры
- Timestamp

---

*Версия: v3.3.0*
