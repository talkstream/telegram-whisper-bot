# План рефакторинга и оптимизации Telegram Whisper Bot (v2.1)

Актуализированный план на основе глубокого анализа архитектуры и логов (14.01.2026).

## Часть 1: Оптимизация DevOps (Приоритет: Высокий)

**Проблема:** Сборка `audio-processor` занимает 15 минут. Синхронизация кода ручная и ненадежная.
**Решение:** Внедрение Google Cloud Build (`cloudbuild.yaml`) для стандартизации CI/CD.

1.  **[DONE] Создание `Dockerfile.base`:**
    *   Содержит: OS, Dependencies, FFmpeg 8.0 (compiled), Whisper.cpp, Whisper Model.
    *   Сборка: `gcr.io/editorials-robot/audio-processor-base:v1`.
2.  **[DONE] Конфигурация `cloudbuild.base.yaml`:**
    *   Декларативное описание сборки базового образа.
    *   Запуск: `gcloud builds submit --config cloudbuild.base.yaml .`
3.  **[DONE] Конфигурация `cloudbuild.app.yaml`:**
    *   Автоматическая синхронизация папки `services/` перед сборкой.
    *   Сборка легкого образа приложения (`Dockerfile` from base).
    *   Автоматический деплой в Cloud Run.
4.  **[TODO] Запуск сборки базового образа** (единоразово).

## Часть 2: Архитектурный Рефакторинг (Приоритет: Высокий)

**Проблема:** `main.py` ("Bot") выполняет тяжелую конвертацию видео, вызывая тайм-ауты и требуя наличия FFmpeg в контейнере бота.
**Решение:** Перенос всей обработки медиа в `audio-processor`.

1.  **Модификация `main.py`:**
    *   Удалить функцию `process_video_file` (и локальный вызов ffmpeg).
    *   Для видео-файлов: просто публиковать задачу в Pub/Sub с типом `video` (или просто передавать `file_id`).
2.  **Модификация `audio_processor.py`:**
    *   Убедиться, что он умеет скачивать видео по `file_id`.
    *   Использовать существующую логику `extract_audio_from_video` сразу после скачивания.
    *   Обновить `Dockerfile.base` бота (`whisper-bot`), убрав оттуда FFmpeg (экономия размера/памяти), если он там есть.

## Часть 3: Надежность и Обработка Ошибок (Приоритет: Средний)

**Проблема:** "Сглатывание" ошибок (всегда 200 OK) и ненадежный парсинг логов.

1.  **Dead Letter Queue (DLQ):**
    *   Настроить топик `audio-processing-dlq`.
    *   В `audio_processor.py`: различать `ValueError` (200 OK + уведомление юзера) и `SystemError/NetworkError` (500 Error -> Retry -> DLQ).
2.  **JSON Parser для FFmpeg:**
    *   Переписать `_parse_ffmpeg_whisper_output` на использование JSON-вывода, который мы уже запрашиваем флагом `format=json`.

## Часть 4: Очистка (Приоритет: Низкий)

1.  Удалить легаси-код в `main.py` (синхронная обработка).
2.  Унифицировать структуру папок (возможно, использовать symlinks или mount при локальной разработке, но для Cloud Run оставить копирование).

---

## План действий на сегодня

1.  Создать `Dockerfile.base` и скрипты сборки.
2.  Обновить деплой `audio-processor` с авто-синхронизацией.
3.  (Если успеем) Начать перенос обработки видео в воркер.